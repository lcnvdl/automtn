/**
 * Automtn.js
 *
 * @author     	Luciano Rasente
 * @link		https://github.com/lcnvdl/automtn
 * @copyright 	Copyright(c) 2013 Luciano Rasente
 * @licence		MIT Licensed
 */
 "undefined"===typeof String.prototype.replaceAll&&(String.prototype.replaceAll=function(b,c){for(var a=this;-1!==a.toString().indexOf(b);)a=a.toString().replace(b,c);return a});"undefined"===typeof Array.prototype.getKey&&(Array.prototype.getKey=function(){for(var b in this)if(this.propertyIsEnumerable(b))return b});
var Automtn={id:1,fill:function(b,c,a){c=typeof c=="string"?{"?":c}:c;c.length==1&&(c=c[c.getKey()]);Automtn._fill[a||"div"](b,c)},call:function(b,c,a){if(typeof c==="string"){if(c=="")return null;c=typeof a==="undefined"?new Function(c):new Function("args",c)}else if(typeof c!=="function")return null;return c?c.call(b,a):null},_val:function(b,c,a,e){return(e||b.data("tpl")).replaceAll("{key}",c).replaceAll("{value}",a)},_fill:{table:function(b,c){b.html().toLowerCase().indexOf("tbody")!==-1&&b.find("tbody");
var a=b.data("tpl");a=="{value}"&&b.data("tpl","<td>{value}</td>");var e=b.data("tpl-tr");if(typeof e==="undefined"){e="<tr data-key='{key}'>{value}</td>";b.data("tpl-tr",e)}$.each(c,function(a,c){var g=$("<tr>"),h;h=$.isArray(c)?c:[c];(b.data("data-showkey")=="1"||b.data("data-showkey")=="true"||b.data("data-showkey")===true)&&$("<td>").attr("data-key",a).html(a).appendTo(g);for(var i=0;i<h.length;i++){var j=Automtn._val(b,a,h[i]);g.appendStr(j)}$(Automtn._val(b,a,g.html(),e)).appendTo(b);g.remove()})},
div:function(b,c){typeof c=="string"&&(c={"?":c});$.each(c,function(a,c){var d=Automtn._val(b,a,c);b.appendStr(d)})}}};
(function(b){b.fn.appendStr=function(c){var a=b(this);a.html(a.html()+c);return a};b.fn.automtn=function(c){var a=b(this),c=c||{},e=String(c.action||"init").toLowerCase(),d=a.attr("id");if(typeof d==="undefined"||d==""){d="auto-"+Automtn.id++;a.attr("id",d)}if(e=="init"){a.data("init",true);var f=function(b,d){var e=c[b]||a.data(b);if(typeof e==="undefined"){a.attr("data-"+b,d||"");return d}return e};f("fetch");var d=f("fill","self"),g=f("events",""),e=f("method","POST");f("tpl","{value}");var h=
f("subscript"),e=f("filltype",""),i=f("loadstart"),j=f("loadfinish"),k=f("loaderror"),l=f("loadsuccess");if(typeof g!=="undefined"&&g!=""){i=g.split(",");for(f=0;f<i.length;f++){g=i[f].trim();if(g=="document-ready")b(document).ready(function(){a.automtn({action:"fetch"})});else{var g=g.split("-"),m=b(g[0]);if(m.length>0)m.on(g[1],function(){a.automtn({action:"fetch"})})}}}typeof h!=="undefined"&&h!=""&&eval(h);if(d!=""){if(d.toLowerCase()=="self")d=a;else{d=b(d);if(d.length==0){a.data("init",false);
return a}}a.data("element",d);if(e==""){e=d[0].tagName.toLowerCase();a.data("filltype",e)}}}else if(a.data("init"))if(e=="fill"){d=c.data||{};e=a.data("filltype");Automtn.fill(a,d,e);a.attr("data-filled","true");a.trigger("onfill")}else{h=a.data("request");f=a.data("fetch");i=a.data("loadstart");j=a.data("loadfinish");k=a.data("loaderror");l=a.data("loadsuccess");e=a.data("method");d={};h&&h.abort();try{a.trigger("onloadstart",[a]);Automtn.call(this,i,a)}catch(n){}h=b.ajax({type:e,url:f,data:d,crossDomain:true,
dataType:"jsonp",context:a,success:function(a){this.automtn({action:"fill",data:a});try{this.trigger("onloadsuccess",[this]);Automtn.call(this,l)}catch(b){this.trigger("onloaderror",[this]);Automtn.call(this,k,b)}Automtn.call(this,j);this.trigger("onloadfinish",[this,true,a])},error:function(a,b,c){a=[b,c,a];this.trigger("onloaderror",[this]);this.trigger("onloadfinish",[this,false,a]);Automtn.call(this,k,{error:b,result:a});Automtn.call(this,j)},async:true});a.data("request",h)}return a};b(document).ready(function(){b("[data-fetch]").each(function(){b(this).automtn({action:"init"})})})})(jQuery||
$);
