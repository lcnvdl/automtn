/**
 * Automtn.js
 *
 * @date        2013-09-10
 * @author     	Luciano Rasente
 * @link        https://github.com/lcnvdl/automtn
 * @copyright   Copyright(c) 2013 Luciano Rasente
 * @licence     MIT Licensed
 */

"undefined"===typeof String.prototype.replaceAll&&(String.prototype.replaceAll=function(b,c){for(var a=this;-1!==a.toString().indexOf(b);)a=a.toString().replace(b,c);return a});"undefined"===typeof Array.prototype.getKey&&(Array.prototype.getKey=function(){for(var b in this)if(this.propertyIsEnumerable(b))return b});
(function(b){b.fn.appendStr=function(c){var a=b(this);a.html(a.html()+c);return a};b.fn.automtn=function(c){var a=b(this),c=c||{},d=String(c.action||"init").toLowerCase(),f=a.attr("id");if(typeof f==="undefined"||f==""){f="auto-"+Automtn.id++;a.attr("id",f)}if(d=="init"){a.data("init",true);var e=function(b,d){var e=c[b];e?a.data(b,e):e=a.data(b);if(typeof e==="undefined"&&typeof d!=="undefined"){d===null?a.data(b,d):a.attr("data-"+b,d||"");return d}return e};e("fetch");e("onlyvalue",Automtn.defaults.onlyvalue?
"true":"false");var g=e("fill","self"),f=e("events",""),h=e("method",Automtn.defaults.method);e("tpl","{value}");var l=e("subscript"),h=e("filltype",""),d=e("external",Automtn.defaults.external?"true":"false"),d=e("mode",Automtn.mode.Overwrite),d=e("key",null);e("value",null);var i=e("loadstart"),j=e("loadfinish"),k=e("loaderror"),n=e("loadsuccess");typeof l!=="undefined"&&l!=""&&eval(l);if(g!=""){if(g.toLowerCase()=="self")d=a;else{d=b(g);if(d.length==0){a.data("init",false);return a}}a.data("element",
d);if(h==""){h=d[0].tagName.toLowerCase();a.data("filltype",h)}}if(typeof f!=="undefined"&&f!="")for(var f=f.split(","),m=function(){a.automtn({action:"fetch"})},h=0;h<f.length;h++){d=f[h].trim();if(d=="document-ready")b(document).ready(function(){m()});else if(d=="now")m();else{i=d.split("-");d=b(i[0]);if(d.length>0)d.on(i[1],function(){m()})}}}else if(a.data("init"))if(d=="fill"){f=c.data||{};h=a.data("filltype");d=a.data("mode");Automtn.fill(a,f,h,d);a.attr("data-filled","true");a.trigger("onfill")}else{e=
a.data("request");g=a.data("fetch");d=String(a.data("external"))=="true";i=a.data("loadstart");j=a.data("loadfinish");k=a.data("loaderror");n=a.data("loadsuccess");h=a.data("method");f={};e&&e.abort();try{a.trigger("onloadstart",[a]);Automtn.call(this,i,a)}catch(o){}f={type:h,url:g,data:f,context:a,success:function(b){this.trigger("beforefill",[b]);this.automtn({action:"fill",data:b});try{this.trigger("onloadsuccess",[this]);Automtn.call(this,n)}catch(a){this.trigger("onloaderror",[this]);Automtn.call(this,
k,a)}Automtn.call(this,j);this.trigger("onloadfinish",[this,true,b])},error:function(b,a,c){b=[a,c,b];this.trigger("onloaderror",[this]);this.trigger("onloadfinish",[this,false,b]);Automtn.call(this,k,{error:a,result:b});Automtn.call(this,j)},async:true};if(d)f.dataType="jsonp";else{f.dataType="json";f.contentType="application/json; charset=utf-8"}e=b.ajax(f);a.data("request",e)}return a};b(document).ready(function(){b("[data-fetch]").each(function(){b(this).automtn({action:"init"})})})})(jQuery||
$);
var Automtn={id:1,defaults:{method:"POST",external:!1,onlyvalue:!1},mode:{Overwrite:"overwrite",Append:"append"},each:function(b,c,a){var d=b.data("key"),f=b.data("value");if(String(b.data("onlyvalue")).toLowerCase()=="false"){if($.isArray(c)){for(var b={},e=0;e<c.length;e++){var g=c[e];typeof g==="object"?b[d?g[d]:e]=f?g[f]:g:b[e]=g}c=b}$.each(c,a)}else{var h={};if($.isArray(c))for(e=0;e<c.length;e++){g=c[e];typeof g==="object"?h[d?g[d]:e]=f?g[f]:g:h[e]=g}else $.each(c,function(b,a){if(typeof a==="string"||
typeof a==="number")h[b]=a});$.each(h,a)}},fill:function(b,c,a,d){d=d||Automtn.mode.Overwrite;c=typeof c=="string"?{"?":c}:c;c.length==1&&(c=c[c.getKey()]);(Automtn._fill[a]||Automtn._fill.div)(b,c,d)},call:function(b,c,a){if(typeof c==="string"){if(c=="")return null;c=typeof a==="undefined"?new Function(c):new Function("args",c)}else if(typeof c!=="function")return null;return c?c.call(b,a):null},_val:function(b,c,a,d){return(d||b.data("tpl")).replaceAll("{key}",c).replaceAll("{value}",a)},_fill:{ol:function(b,
c,a){return Automtn._fill.ul(b,c,a)},ul:function(b,c,a){a==Automtn.mode.Overwrite&&b.html("");var d=b.data("tpl");if(d=="{value}"){d="<li>{value}</li>";b.data("tpl",d)}Automtn.each(b,c,function(a,c){var g=Automtn._val(b,a,c,d);b.appendStr(g)})},select:function(b,c,a){a==Automtn.mode.Overwrite&&b.html("");var d=b.data("tpl");if(d=="{value}"){d="<option value={value}>{key}</li>";b.data("tpl",d)}Automtn.each(b,c,function(a,c){var g=Automtn._val(b,a,c,d);b.appendStr(g)})},table:function(b,c,a){var d=
b.children("tbody"),f=d.length>0?d:b;a==Automtn.mode.Overwrite&&f.html("");a=b.data("tpl");a=="{value}"&&b.data("tpl","<td>{value}</td>");var e=b.data("tpl-tr");if(typeof e==="undefined"){e="<tr data-key='{key}'>{value}</td>";b.data("tpl-tr",e)}Automtn.each(b,c,function(a,c){var d=$("<tr>"),i;i=$.isArray(c)?c:[c];(b.data("data-showkey")=="1"||b.data("data-showkey")=="true"||b.data("data-showkey")===true)&&$("<td>").attr("data-key",a).html(a).appendTo(d);for(var j=0;j<i.length;j++){var k=Automtn._val(b,
a,i[j]);d.appendStr(k)}$(Automtn._val(b,a,d.html(),e)).appendTo(f);d.remove()})},div:function(b,c,a){typeof c=="string"&&(c={"?":c});a==Automtn.mode.Overwrite&&b.html("");Automtn.each(b,c,function(a,c){var e=Automtn._val(b,a,c);b.appendStr(e)})}}};
