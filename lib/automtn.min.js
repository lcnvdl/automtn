/**
 * Automtn.js
 *
 * @date        2013-08-27
 * @author     	Luciano Rasente
 * @link        https://github.com/lcnvdl/automtn
 * @copyright   Copyright(c) 2013 Luciano Rasente
 * @licence     MIT Licensed
 */
"undefined"===typeof String.prototype.replaceAll&&(String.prototype.replaceAll=function(b,c){for(var a=this;-1!==a.toString().indexOf(b);)a=a.toString().replace(b,c);return a});"undefined"===typeof Array.prototype.getKey&&(Array.prototype.getKey=function(){for(var b in this)if(this.propertyIsEnumerable(b))return b});
var Automtn={id:1,mode:{Overwrite:"overwrite",Append:"append"},fill:function(b,c,a,d){d=d||Automtn.mode.Overwrite;c=typeof c=="string"?{"?":c}:c;c.length==1&&(c=c[c.getKey()]);Automtn._fill[a||"div"](b,c,d)},call:function(b,c,a){if(typeof c==="string"){if(c=="")return null;c=typeof a==="undefined"?new Function(c):new Function("args",c)}else if(typeof c!=="function")return null;return c?c.call(b,a):null},_val:function(b,c,a,d){return(d||b.data("tpl")).replaceAll("{key}",c).replaceAll("{value}",a)},
_fill:{ol:function(b,c,a){return Automtn._fill.ul(b,c,a)},ul:function(b,c,a){a==Automtn.mode.Overwrite&&b.html("");var d=b.data("tpl");if(d=="{value}"){d="<li>{value}</li>";b.data("tpl",d)}$.each(c,function(a,c){var g=Automtn._val(b,a,c,d);b.appendStr(g)})},table:function(b,c,a){var d=b.children("tbody"),f=d.length>0?d:b;a==Automtn.mode.Overwrite&&f.html("");a=b.data("tpl");a=="{value}"&&b.data("tpl","<td>{value}</td>");var e=b.data("tpl-tr");if(typeof e==="undefined"){e="<tr data-key='{key}'>{value}</td>";
b.data("tpl-tr",e)}$.each(c,function(a,c){var d=$("<tr>"),j;j=$.isArray(c)?c:[c];(b.data("data-showkey")=="1"||b.data("data-showkey")=="true"||b.data("data-showkey")===true)&&$("<td>").attr("data-key",a).html(a).appendTo(d);for(var k=0;k<j.length;k++){var l=Automtn._val(b,a,j[k]);d.appendStr(l)}$(Automtn._val(b,a,d.html(),e)).appendTo(f);d.remove()})},div:function(b,c,a){typeof c=="string"&&(c={"?":c});a==Automtn.mode.Overwrite&&b.html("");$.each(c,function(a,c){var e=Automtn._val(b,a,c);b.appendStr(e)})}}};
(function(b){b.fn.appendStr=function(c){var a=b(this);a.html(a.html()+c);return a};b.fn.automtn=function(c){var a=b(this),c=c||{},d=String(c.action||"init").toLowerCase(),f=a.attr("id");if(typeof f==="undefined"||f==""){f="auto-"+Automtn.id++;a.attr("id",f)}if(d=="init"){a.data("init",true);var e=function(b,d){var e=c[b]||a.data(b);if(typeof e==="undefined"){a.attr("data-"+b,d||"");return d}return e};e("fetch");var f=e("fill","self"),g=e("events",""),d=e("method","POST");e("tpl","{value}");var h=
e("subscript"),d=e("filltype",""),i=e("mode",Automtn.mode.Overwrite),i=e("loadstart"),j=e("loadfinish"),k=e("loaderror"),l=e("loadsuccess");if(typeof g!=="undefined"&&g!=""){i=g.split(",");for(e=0;e<i.length;e++){g=i[e].trim();if(g=="document-ready")b(document).ready(function(){a.automtn({action:"fetch"})});else{var g=g.split("-"),m=b(g[0]);if(m.length>0)m.on(g[1],function(){a.automtn({action:"fetch"})})}}}typeof h!=="undefined"&&h!=""&&eval(h);if(f!=""){if(f.toLowerCase()=="self")f=a;else{f=b(f);
if(f.length==0){a.data("init",false);return a}}a.data("element",f);if(d==""){d=f[0].tagName.toLowerCase();a.data("filltype",d)}}}else if(a.data("init"))if(d=="fill"){f=c.data||{};d=a.data("filltype");i=a.data("mode");Automtn.fill(a,f,d,i);a.attr("data-filled","true");a.trigger("onfill")}else{h=a.data("request");e=a.data("fetch");i=a.data("loadstart");j=a.data("loadfinish");k=a.data("loaderror");l=a.data("loadsuccess");d=a.data("method");f={};h&&h.abort();try{a.trigger("onloadstart",[a]);Automtn.call(this,
i,a)}catch(n){}h=b.ajax({type:d,url:e,data:f,crossDomain:true,dataType:"jsonp",context:a,success:function(a){this.automtn({action:"fill",data:a});try{this.trigger("onloadsuccess",[this]);Automtn.call(this,l)}catch(b){this.trigger("onloaderror",[this]);Automtn.call(this,k,b)}Automtn.call(this,j);this.trigger("onloadfinish",[this,true,a])},error:function(a,b,c){a=[b,c,a];this.trigger("onloaderror",[this]);this.trigger("onloadfinish",[this,false,a]);Automtn.call(this,k,{error:b,result:a});Automtn.call(this,
j)},async:true});a.data("request",h)}return a};b(document).ready(function(){b("[data-fetch]").each(function(){b(this).automtn({action:"init"})})})})(jQuery||$);
